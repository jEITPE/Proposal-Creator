{% extends 'base.html' %}

{% block content %}
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        color: #333;
        line-height: 1.6;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .container-white {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    .section-title {
        font-size: 28px;
        color: #333;
        margin: 0;
    }
    .btn-container {
        display: flex;
        gap: 10px;
    }
    .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        background-color: #0069d9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }
    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
    }
    .form-group {
        margin-bottom: 25px;
    }
    .form-label {
        display: block;
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 10px;
        color: #333;
    }
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        transition: border-color 0.3s;
    }
    .form-control:focus {
        border-color: #80bdff;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .form-text {
        font-size: 14px;
        color: #6c757d;
        margin-top: 5px;
    }
    .logo-options {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }
    .logo-option {
        flex: 1;
        background-color: white;
        border-radius: 4px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .logo-option-title {
        font-weight: 500;
        margin-bottom: 15px;
        color: #333;
    }
    .file-input-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .file-input-button {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
    }
    .file-input-button:hover {
        background-color: #0069d9;
    }
    .file-input-button input[type="file"] {
        display: none;
    }
    .file-name {
        color: #6c757d;
        font-size: 14px;
    }
    .blocos-section {
        margin-top: 30px;
    }
    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .blocos-category {
        margin-bottom: 25px;
    }
    .blocos-category-title {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 15px;
        color: #333;
        padding-bottom: 5px;
        border-bottom: 1px solid #e9ecef;
    }
    .checkbox-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    .checkbox-item {
        flex: 0 0 calc(33.333% - 15px);
        display: flex;
        align-items: flex-start;
    }
    .checkbox-item input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 3px;
    }
    .checkbox-item label {
        font-size: 16px;
        color: #333;
    }
    .mandatory-badge {
        display: inline-block;
        background-color: #dc3545;
        color: white;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 3px;
        margin-left: 5px;
    }
    .submit-container {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    .preview-section {
        margin-top: 30px;
        background-color: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .preview-container {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        background-color: #fff;
    }
    .preview-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    .preview-logo {
        margin-right: 20px;
    }
    .preview-logo img {
        max-width: 100px;
        max-height: 100px;
        border: 1px solid #e9ecef;
        padding: 5px;
        border-radius: 4px;
    }
    .preview-title {
        flex: 1;
    }
    .preview-title h2 {
        font-size: 22px;
        color: #333;
        margin: 0 0 5px 0;
    }
    .preview-title h3 {
        font-size: 18px;
        color: #6c757d;
        margin: 0;
        font-weight: normal;
    }
    .preview-content {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }
    .preview-blocks {
        flex: 1;
        min-width: 250px;
    }
    .preview-blocks h4 {
        font-size: 18px;
        color: #333;
        margin: 0 0 15px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
    }
    .preview-blocks ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .preview-blocks li {
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    .preview-sample {
        flex: 2;
        min-width: 300px;
    }
    .preview-sample h4 {
        font-size: 18px;
        color: #333;
        margin: 0 0 15px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
    }
    .preview-block-content {
        margin-bottom: 20px;
    }
    .preview-block-content h5 {
        font-size: 16px;
        color: #333;
        margin: 0 0 10px 0;
    }
    .preview-text {
        font-size: 14px;
        color: #6c757d;
        line-height: 1.5;
    }
    .preview-text p {
        margin: 0 0 10px 0;
    }
    @media (max-width: 768px) {
        .checkbox-item {
            flex: 0 0 100%;
        }
        .logo-options {
            flex-direction: column;
        }
        .preview-content {
            flex-direction: column;
        }
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        .section-header .btn-container {
            flex-wrap: wrap;
        }
        .submit-container {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        .submit-container button {
            width: 100%;
        }
        .preview-header {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .preview-logo {
            margin-right: 0;
            margin-bottom: 15px;
        }
    }
    .ofertas-section {
        margin-bottom: 30px;
    }
    
    .ofertas-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }
    
    .oferta-tab {
        padding: 10px 20px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer !important;
        pointer-events: auto !important;
        transition: all 0.3s ease;
        font-weight: 500;
        text-align: center;
        position: relative;
        z-index: 10;
    }
    
    .oferta-tab:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
    }
    
    .oferta-tab.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .oferta-content {
        display: none;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #fff;
    }
    
    .oferta-content.active {
        display: block;
    }
    
    .oferta-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .oferta-title {
        font-size: 20px;
        color: #333;
        margin: 0;
    }
    
    .oferta-description {
        color: #6c757d;
        margin-top: 5px;
    }
    
    @media (max-width: 768px) {
        .ofertas-tabs {
            flex-direction: column;
        }
        
        .checkbox-item {
            flex: 0 0 100%;
        }
    }
    
    /* Estilos para o modal de edição de blocos */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 900px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 20px;
    }
    
    .modal-title {
        font-size: 22px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }
    
    .modal-footer {
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .btn-editar-bloco {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 3px 8px;
        border-radius: 4px;
        cursor: pointer !important;
        font-size: 12px;
        margin-left: 10px;
        pointer-events: auto !important;
        position: relative;
        z-index: 100;
    }
    
    .btn-editar-bloco:hover {
        background-color: #0069d9;
    }
    
    /* Estilos para as abas de ofertas */
    .oferta-tab {
        cursor: pointer !important;
        pointer-events: auto !important;
    }

    /* Estilos para o indicador de carregamento */
    .loading {
        position: relative;
    }
    
    .loading:after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.7) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="%23007bff" stroke-width="10" r="35" stroke-dasharray="164.93361431346415 56.97787143782138"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg>') center center no-repeat;
        background-size: 50px 50px;
        z-index: 10;
    }
</style>

{% if get_flashed_messages() %}
<div class="alert alert-info">
    {% for message in get_flashed_messages() %}
        {{ message }}
    {% endfor %}
</div>
{% endif %}

<div class="container-white">
    <div class="section-header">
        <h2 class="section-title">Criar Nova Proposta</h2>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('exibir_criar_proposta', nova=1) }}" class="btn-primary">Nova Proposta</a>
            <a href="{{ url_for('dashboard') }}" class="btn-secondary">Voltar ao Dashboard</a>
        </div>
    </div>

    <form id="propostaForm" action="{{ url_for('criar_proposta') }}" method="post" enctype="multipart/form-data">
        {% if rascunho_id %}
        <input type="hidden" name="rascunho_id" value="{{ rascunho_id }}">
        {% endif %}
        <div class="form-group">
            <label for="nome_cliente" class="form-label">Nome do Cliente</label>
            <input type="text" id="nome_cliente" name="nome_cliente" class="form-control" value="{{ rascunho.nome_cliente or cliente }}" required>
            <small class="form-text">Digite o nome completo do cliente para a proposta.</small>
        </div>

        <div class="form-group">
            <label class="form-label">Logo do Cliente</label>
            
            <div class="logo-options">
                <div class="logo-option">
                    <div class="logo-option-title">Upload de Arquivo</div>
                    <div class="file-input-container">
                        <label class="file-input-button">
                            Escolher arquivo
                            <input type="file" id="logo_file" name="logo_file" accept="image/*" onchange="updateFileName(this); previewLogo(this)">
                        </label>
                        <span class="file-name" id="file-name">
                            {% if rascunho.logo_cliente and ('/' in rascunho.logo_cliente or '\\' in rascunho.logo_cliente) %}
                                Arquivo selecionado
                            {% else %}
                                Nenhum arquivo selecionado
                            {% endif %}
                        </span>
                    </div>
                    <small class="form-text">Formatos aceitos: JPG, PNG, GIF (máx. 2MB)</small>
                </div>
            </div>
            
            {% if rascunho.logo_cliente and ('/' in rascunho.logo_cliente or '\\' in rascunho.logo_cliente) %}
            <div style="margin-top: 15px;">
                <p><strong>Logo atual:</strong></p>
                <img src="/{{ rascunho.logo_cliente }}" 
                     alt="Logo do cliente" style="max-height: 100px; max-width: 200px; border: 1px solid #ddd; padding: 5px;">
                <input type="hidden" name="logo_atual" value="{{ rascunho.logo_cliente }}">
            </div>
            {% endif %}
        </div>

        <!-- Seção de Ofertas -->
        <div class="ofertas-section">
            <label class="form-label">Selecione a Oferta</label>
            
            <div class="alert alert-info">
                <strong>Nota:</strong> Clique no nome de qualquer bloco para editar seu conteúdo e personalizá-lo para este cliente específico.
            </div>
            
            <div class="ofertas-tabs">
                {% for oferta_nome, oferta_dados in ofertas.items() %}
                <div class="oferta-tab {% if rascunho.oferta_selecionada == oferta_nome %}active{% elif loop.first and not rascunho.oferta_selecionada %}active{% endif %}" 
                     data-oferta="{{ oferta_nome }}" onclick="selecionarOferta('{{ oferta_nome }}')">
                    {{ oferta_nome }}
                </div>
                {% endfor %}
            </div>
            
            <input type="hidden" name="oferta_selecionada" id="oferta_selecionada" value="{{ rascunho.oferta_selecionada or primeira_oferta }}">
            
            {% for oferta_nome, oferta_dados in ofertas.items() %}
            <div class="oferta-content {% if rascunho.oferta_selecionada == oferta_nome %}active{% elif loop.first and not rascunho.oferta_selecionada %}active{% endif %}" 
                 id="oferta-{{ oferta_nome }}">
                <div class="oferta-header">
                    <h3 class="oferta-title">{{ oferta_nome }}</h3>
                    <p class="oferta-description">Selecione os blocos para esta oferta</p>
                </div>
                
                <!-- Blocos Obrigatórios -->
                <div class="blocos-category">
                    <h4 class="blocos-category-title">Blocos Obrigatórios</h4>
                    <div class="checkbox-container">
                        {% for bloco_nome in oferta_dados.obrigatorios %}
                        <div class="checkbox-item">
                            <input type="checkbox" id="bloco-{{ bloco_nome }}" name="blocos" value="{{ bloco_nome }}" 
                                   {% if bloco_nome in rascunho.blocos_selecionados %}checked{% endif %} checked disabled>
                            <label for="bloco-{{ bloco_nome }}">
                                {{ bloco_nome.replace('_', ' ').capitalize() }}
                                <span class="mandatory-badge">Obrigatório</span>
                                <button type="button" class="btn-editar-bloco" data-bloco="{{ bloco_nome }}">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Blocos Específicos -->
                <div class="blocos-category">
                    <h4 class="blocos-category-title">Blocos Específicos</h4>
                    <div class="checkbox-container">
                        {% for bloco_nome, bloco_dados in oferta_dados.blocos.items() %}
                        <div class="checkbox-item">
                            <input type="checkbox" id="bloco-{{ bloco_nome }}" name="blocos" value="{{ bloco_nome }}"
                                   {% if bloco_nome in rascunho.blocos_selecionados %}checked{% endif %}>
                            <label for="bloco-{{ bloco_nome }}">
                                {{ bloco_nome.replace('_', ' ').capitalize() }}
                                <button type="button" class="btn-editar-bloco" data-bloco="{{ bloco_nome }}">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Blocos Adicionais -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Blocos Selecionados</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <button type="button" id="btnNovoBloco" class="btn btn-success" onclick="novoBloco()">
                            <i class="fas fa-plus"></i> Adicionar Novo Bloco
                        </button>
                    </div>
                </div>
                <div class="row">
                    {% for bloco in blocos_selecionados %}
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">{{ bloco.replace('_', ' ').title() }}</h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="editarBloco('{{ bloco }}')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="excluirBloco('{{ bloco }}')">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="submit-container">
            <div>
                <!-- Botão de salvar como rascunho removido, pois o auto-save já está implementado -->
            </div>
            <div>
                <button type="submit" class="btn-primary">Gerar Proposta</button>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Edição de Bloco -->
<div id="modalEditarBloco" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Editar Bloco: <span id="modalBlocoTitulo"></span></h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Editor Quill -->
            <div id="editor-bloco" style="height: 300px;"></div>
            <input type="hidden" id="blocoAtual" value="">
            <input type="hidden" id="blocoConteudo" value="">
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="btnCancelarEdicao">Cancelar</button>
            <button type="button" class="btn-primary" id="btnSalvarEdicao">Salvar Alterações</button>
        </div>
    </div>
</div>

<!-- Modal de Novo Bloco -->
<div id="modalNovoBloco" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Criar Novo Bloco</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group mb-3">
                <label for="nomeNovoBloco" class="form-label">Nome do Bloco:</label>
                <input type="text" id="nomeNovoBloco" class="form-control" placeholder="Ex: Descrição do Serviço">
            </div>
            <!-- Editor Quill para o conteúdo -->
            <div class="form-group">
                <label for="editor-novo-bloco" class="form-label">Conteúdo do Bloco:</label>
                <div id="editor-novo-bloco" style="height: 300px;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="btnCancelarNovo">Cancelar</button>
            <button type="button" class="btn-primary" id="btnSalvarNovo">Criar Bloco</button>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

<script>
    function updateFileName(input) {
        const fileName = input.files[0] ? input.files[0].name : 'Nenhum arquivo selecionado';
        document.getElementById('file-name').textContent = fileName;
    }

    function previewLogo(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Apenas exibir a imagem selecionada se necessário
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar o editor Quill
        const quill = new Quill('#editor-bloco', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Edite o conteúdo do bloco aqui...'
        });
        
        // Inicializar o editor Quill para novos blocos
        const quillNovo = new Quill('#editor-novo-bloco', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Digite o conteúdo do novo bloco aqui...'
        });
        
        // Configurar o modal de edição
        const modal = document.getElementById('modalEditarBloco');
        const modalNovo = document.getElementById('modalNovoBloco');
        const span = modal.getElementsByClassName('close')[0];
        const spanNovo = modalNovo.getElementsByClassName('close')[0];
        const btnCancelar = document.getElementById('btnCancelarEdicao');
        const btnCancelarNovo = document.getElementById('btnCancelarNovo');
        const btnSalvar = document.getElementById('btnSalvarEdicao');
        const btnSalvarNovo = document.getElementById('btnSalvarNovo');
        
        span.onclick = function() {
            modal.style.display = 'none';
        }
        
        btnCancelar.onclick = function() {
            modal.style.display = 'none';
        }
        
        // Configurar botões de fechamento do modal novo bloco
        spanNovo.onclick = function() {
            modalNovo.style.display = 'none';
        }
        
        btnCancelarNovo.onclick = function() {
            modalNovo.style.display = 'none';
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            if (event.target == modalNovo) {
                modalNovo.style.display = 'none';
            }
        }
        
        // Configurar o botão de salvar edição
        btnSalvar.onclick = function() {
            const blocoNome = document.getElementById('blocoAtual').value;
            const conteudo = quill.root.innerHTML;
            
            console.log('Salvando bloco:', blocoNome);
            
            // Desabilitar o botão durante o salvamento
            btnSalvar.disabled = true;
            btnSalvar.textContent = 'Salvando...';
            
            // Salvar o conteúdo editado
            fetch('/api/salvar_bloco', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: blocoNome,
                    texto: conteudo
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Resposta do servidor:', data);
                
                if (data.success) {
                    alert('Bloco salvo com sucesso!');
                    modal.style.display = 'none';
                } else {
                    alert('Erro ao salvar o bloco: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar o bloco: ' + error.message);
            })
            .finally(() => {
                // Reabilitar o botão após o salvamento
                btnSalvar.disabled = false;
                btnSalvar.textContent = 'Salvar Alterações';
            });
        };
        
        // Configurar o botão de salvar novo bloco
        btnSalvarNovo.onclick = function() {
            const blocoNome = document.getElementById('nomeNovoBloco').value.trim().replace(/\s+/g, '_');
            const conteudo = quillNovo.root.innerHTML;
            
            if (!blocoNome) {
                alert('Por favor, informe um nome para o bloco.');
                return;
            }
            
            console.log('Criando novo bloco:', blocoNome);
            
            // Desabilitar o botão durante o salvamento
            btnSalvarNovo.disabled = true;
            btnSalvarNovo.textContent = 'Salvando...';
            
            // Salvar o novo bloco
            fetch('/api/salvar_bloco', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: blocoNome,
                    texto: conteudo
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Resposta do servidor:', data);
                
                if (data.success) {
                    alert('Bloco criado com sucesso!');
                    modalNovo.style.display = 'none';
                    
                    // Recarregar a página para mostrar o novo bloco
                    location.reload();
                } else {
                    alert('Erro ao criar o bloco: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao criar o bloco: ' + error.message);
            })
            .finally(() => {
                // Reabilitar o botão após o salvamento
                btnSalvarNovo.disabled = false;
                btnSalvarNovo.textContent = 'Criar Bloco';
            });
        };
        
        // Configurar os botões de edição inicialmente
        configurarBotoesEdicao();
    });
    
    // Função para editar um bloco
    function editarBloco(blocoNome) {
        const modal = document.getElementById('modalEditarBloco');
        const modalTitulo = document.getElementById('modalBlocoTitulo');
        const blocoAtual = document.getElementById('blocoAtual');
        
        console.log('Editando bloco:', blocoNome);
        
        // Definir o título do modal e o bloco atual
        modalTitulo.textContent = blocoNome.replace(/_/g, ' ').capitalize();
        blocoAtual.value = blocoNome;
        
        // Exibir o modal antes de carregar o conteúdo
        modal.style.display = 'block';
        
        // Inicializar o editor com conteúdo vazio
        const quill = Quill.find(document.getElementById('editor-bloco'));
        quill.root.innerHTML = '<p>Carregando conteúdo...</p>';
        
        // Carregar o conteúdo do bloco
        fetch(`/api/bloco/${blocoNome}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Dados do bloco recebidos:', data);
                
                // Inicializar o editor com o conteúdo do bloco
                quill.root.innerHTML = data.texto || '';
            })
            .catch(error => {
                console.error('Erro ao carregar o bloco:', error);
                quill.root.innerHTML = '<p>Erro ao carregar o conteúdo do bloco. Você pode editar mesmo assim e o bloco será criado.</p>';
            });
    }
    
    // Função para configurar os botões de edição
    function configurarBotoesEdicao() {
        document.querySelectorAll('.btn-editar-bloco').forEach(btn => {
            btn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const blocoNome = this.getAttribute('data-bloco');
                editarBloco(blocoNome);
            };
        });
    }
    
    // Função para selecionar uma oferta
    function selecionarOferta(ofertaNome) {
        // Atualizar o campo hidden com a oferta selecionada
        document.getElementById('oferta_selecionada').value = ofertaNome;
        
        // Atualizar as abas
        document.querySelectorAll('.oferta-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.oferta-tab[data-oferta="${ofertaNome}"]`).classList.add('active');
        
        // Atualizar o conteúdo
        document.querySelectorAll('.oferta-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`oferta-${ofertaNome}`).classList.add('active');
    }
    
    // Adicionar método capitalize ao protótipo de String
    String.prototype.capitalize = function() {
        return this.charAt(0).toUpperCase() + this.slice(1);
    };

    // Adicionar esta função no script do template criar_proposta.html
    function excluirBloco(blocoNome) {
        if (confirm(`Tem certeza que deseja excluir o bloco "${blocoNome}"?`)) {
            fetch(`/api/excluir_bloco/${blocoNome}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Bloco excluído com sucesso!');
                    location.reload(); // Recarrega a página para atualizar a lista
                } else {
                    alert('Erro ao excluir o bloco: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir o bloco: ' + error.message);
            });
        }
    }

    // Função para criar um novo bloco
    function novoBloco() {
        const modal = document.getElementById('modalNovoBloco');
        const quillNovo = Quill.find(document.getElementById('editor-novo-bloco'));
        
        // Limpar campos do formulário
        document.getElementById('nomeNovoBloco').value = '';
        quillNovo.root.innerHTML = '';
        
        // Exibir o modal
        modal.style.display = 'block';
    }
</script>
{% endblock %} 

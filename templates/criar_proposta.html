{% extends 'base.html' %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Poppins', 'Segoe UI', sans-serif;
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
    }
    
    .container-white {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        padding: 35px;
        margin-bottom: 30px;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    /* Estilos para cabeçalhos e títulos */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 35px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f2f5;
    }
    
    .section-title {
        font-size: 28px;
        color: #2c3e50;
        margin: 0;
        font-weight: 600;
        position: relative;
    }
    
    .section-title:after {
        content: '';
        position: absolute;
        bottom: -15px;
        left: 0;
        width: 60px;
        height: 4px;
        background: linear-gradient(90deg, #3498db, #2980b9);
        border-radius: 2px;
    }
    
    /* Estilos para botões */
    .btn-container {
        display: flex;
        gap: 12px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #2980b9, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #7f8c8d, #95a5a6);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(127, 140, 141, 0.2);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(127, 140, 141, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .btn-danger:hover {
        background: linear-gradient(135deg, #c0392b, #e74c3c);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3);
    }
    
    .btn-info {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .btn-info:hover {
        background: linear-gradient(135deg, #2980b9, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
    }
    
    /* Estilos para formulários */
    .form-group {
        margin-bottom: 30px;
    }
    
    .form-label {
        display: block;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #2c3e50;
    }
    
    .form-control {
        width: 100%;
        padding: 14px 18px;
        border: 1px solid #e0e6ed;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background-color: #f9fafc;
        color: #2c3e50;
    }
    
    .form-control:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        background-color: #fff;
    }
    
    .form-text {
        font-size: 14px;
        color: #7f8c8d;
        margin-top: 8px;
    }
    
    /* Estilos para upload de logo */
    .logo-options {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .logo-option {
        flex: 1;
        background-color: #f9fafc;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e0e6ed;
    }
    
    .logo-option-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 16px;
    }
    
    .file-input-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .file-input-button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 15px;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
    }
    
    .file-input-button:hover {
        background: linear-gradient(135deg, #2980b9, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
    }
    
    .file-input-button input[type="file"] {
        display: none;
    }
    
    .file-name {
        color: #7f8c8d;
        font-size: 14px;
    }
    
    /* Estilos para alertas */
    .alert {
        padding: 18px 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        font-size: 15px;
        display: flex;
        align-items: center;
        border-left: 4px solid;
    }
    
    .alert-info {
        background-color: #e1f0fa;
        color: #2980b9;
        border-color: #3498db;
    }
    
    /* Estilos para as abas de ofertas */
    .ofertas-section {
        margin-bottom: 35px;
    }
    
    .ofertas-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 25px;
        border-bottom: 2px solid #e0e6ed;
        padding-bottom: 15px;
    }
    
    .oferta-tab {
        padding: 12px 24px;
        background-color: #f9fafc;
        border: 1px solid #e0e6ed;
        border-radius: 8px;
        cursor: pointer !important;
        pointer-events: auto !important;
        transition: all 0.3s ease;
        font-weight: 500;
        text-align: center;
        position: relative;
        z-index: 10;
        color: #7f8c8d;
    }
    
    .oferta-tab:hover {
        background-color: #e9f2fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        color: #2980b9;
    }
    
    .oferta-tab.active {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border-color: #2980b9;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
    }
    
    .oferta-content {
        display: none;
        padding: 25px;
        border: 1px solid #e0e6ed;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .oferta-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .oferta-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e6ed;
    }
    
    .oferta-title {
        font-size: 22px;
        color: #2c3e50;
        margin: 0;
        font-weight: 600;
    }
    
    .oferta-description {
        color: #7f8c8d;
        margin-top: 8px;
        font-size: 15px;
    }
    
    /* Estilos para blocos de conteúdo */
    .blocos-category {
        margin-bottom: 30px;
        background-color: #f9fafc;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e0e6ed;
    }
    
    .blocos-category-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #2c3e50;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e6ed;
    }
    
    .checkbox-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    
        .checkbox-item {
        flex: 0 0 calc(33.333% - 15px);
        display: flex;
            align-items: flex-start;
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e6ed;
        transition: all 0.3s ease;
    }
    
    .checkbox-item:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
    }
    
    .checkbox-item input[type="checkbox"] {
        margin-right: 12px;
        margin-top: 3px;
        width: 18px;
        height: 18px;
        accent-color: #3498db;
    }
    
    .checkbox-item label {
        font-size: 15px;
        color: #2c3e50;
        font-weight: 500;
        display: flex;
            flex-direction: column;
        gap: 8px;
    }
    
    .mandatory-badge {
        display: inline-block;
        background-color: #e74c3c;
        color: white;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-editar-bloco {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer !important;
        font-size: 12px;
        margin-top: 8px;
        pointer-events: auto !important;
        position: relative;
        z-index: 100;
        align-self: flex-start;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-editar-bloco:hover {
        background: linear-gradient(135deg, #2980b9, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
    }
    
    /* Estilos para blocos selecionados */
    .card {
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        height: 100%;
        border: none;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    .card-header.bg-dark {
        background: linear-gradient(135deg, #2c3e50, #34495e) !important;
        color: #ffffff;
        padding: 18px 20px;
        font-weight: 600;
        border: none;
    }
    
    .card-header.bg-primary {
        background: linear-gradient(135deg, #3498db, #2980b9) !important;
        color: #ffffff;
        padding: 15px 20px;
        font-weight: 600;
        border: none;
    }
    
    .card-body.bg-light {
        background-color: #f9fafc;
        padding: 25px;
    }
    
    .border-primary {
        border: none !important;
    }
    
    .btn-success.btn-lg {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        border: none;
        padding: 15px 25px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
    }
    
    .btn-success.btn-lg:hover {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
    }
    
    .btn-group.w-100 {
        display: flex;
        gap: 10px;
    }
    
    .btn-group.w-100 .btn {
        flex: 1;
        padding: 12px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }
    
    /* Estilos para o modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 30px;
        border: none;
        width: 80%;
        max-width: 900px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f2f5;
        margin-bottom: 25px;
    }
    
    .modal-title {
        font-size: 24px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .close {
        color: #7f8c8d;
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    .close:hover {
        color: #2c3e50;
        background-color: #f0f2f5;
    }
    
    .modal-footer {
        padding-top: 20px;
        border-top: 2px solid #f0f2f5;
        margin-top: 25px;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    
    /* Estilos responsivos */
    @media (max-width: 768px) {
        .checkbox-item {
            flex: 0 0 100%;
        }
        
        .logo-options {
            flex-direction: column;
        }
        
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
        
        .section-header .btn-container {
            flex-wrap: wrap;
            width: 100%;
        }
        
        .section-header .btn-container a {
            flex: 1;
            text-align: center;
        }
        
        .submit-container {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        
        .submit-container button {
            width: 100%;
        }
        
        .ofertas-tabs {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>

{% if get_flashed_messages() %}
<div class="alert alert-info" style="background-color: #e1f0fa; color: #2980b9; border-left: 4px solid #3498db; padding: 18px 20px; border-radius: 8px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 10px rgba(52, 152, 219, 0.1); animation: fadeIn 0.5s ease;">
    <i class="fas fa-info-circle" style="font-size: 24px;"></i>
    <div>
    {% for message in get_flashed_messages() %}
        {{ message }}
    {% endfor %}
    </div>
</div>
{% endif %}

<div class="container-white">
    <div class="section-header">
        <h2 class="section-title">Criar Nova Proposta</h2>
        <div style="display: flex; gap: 12px;">
            <a href="{{ url_for('exibir_criar_proposta', nova=1) }}" class="btn-primary" style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 12px 20px; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-plus"></i> Nova Proposta
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn-secondary" style="background: linear-gradient(135deg, #7f8c8d, #95a5a6); padding: 12px 20px; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 10px rgba(127, 140, 141, 0.2); display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
            </a>
        </div>
    </div>

    <form id="propostaForm" action="{{ url_for('criar_proposta') }}" method="post" enctype="multipart/form-data">
        {% if rascunho_id %}
        <input type="hidden" name="rascunho_id" value="{{ rascunho_id }}">
        {% endif %}
        <div class="form-group">
            <label for="nome_cliente" class="form-label">Nome do Cliente</label>
            <input type="text" id="nome_cliente" name="nome_cliente" class="form-control" value="{{ rascunho.nome_cliente or cliente }}" required>
            <small class="form-text">Digite o nome completo do cliente para a proposta.</small>
        </div>

        <div class="form-group">
            <label class="form-label">Logo do Cliente</label>
            
            <div class="logo-options">
                <div class="logo-option" style="background-color: #f9fafc; border-radius: 10px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: 1px solid #e0e6ed; transition: all 0.3s ease;">
                    <div class="logo-option-title" style="font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-image" style="color: #3498db;"></i> Upload de Arquivo
                    </div>
                    <div class="file-input-container">
                        <label class="file-input-button" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; margin-right: 15px; font-weight: 500; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-upload"></i> Escolher arquivo
                            <input type="file" id="logo_file" name="logo_file" accept="image/*" onchange="updateFileName(this); previewLogo(this)">
                        </label>
                        <span class="file-name" id="file-name" style="color: #7f8c8d; font-size: 14px;">
                            {% if rascunho.logo_cliente and ('/' in rascunho.logo_cliente or '\\' in rascunho.logo_cliente) %}
                                Arquivo selecionado
                            {% else %}
                                Nenhum arquivo selecionado
                            {% endif %}
                        </span>
                    </div>
                    <small class="form-text" style="color: #7f8c8d; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                        <i class="fas fa-info-circle"></i> Formatos aceitos: JPG, PNG, GIF (máx. 2MB)
                    </small>
                </div>
            </div>
            
            {% if rascunho.logo_cliente and ('/' in rascunho.logo_cliente or '\\' in rascunho.logo_cliente) %}
            <div style="margin-top: 20px; background-color: #f9fafc; border-radius: 10px; padding: 20px; border: 1px solid #e0e6ed; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);">
                <p style="font-weight: 600; color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check-circle" style="color: #2ecc71;"></i> <strong>Logo atual:</strong>
                </p>
                <img src="/{{ rascunho.logo_cliente }}" 
                     alt="Logo do cliente" style="max-height: 100px; max-width: 200px; border: 1px solid #e0e6ed; padding: 10px; border-radius: 8px; background-color: white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                <input type="hidden" name="logo_atual" value="{{ rascunho.logo_cliente }}">
            </div>
            {% endif %}
        </div>

        <!-- Seção de Ofertas -->
        <div class="ofertas-section">
            <label class="form-label">Selecione a Oferta</label>
            
            <div class="alert alert-info" style="background-color: #e1f0fa; color: #2980b9; border-left: 4px solid #3498db; padding: 18px 20px; border-radius: 8px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 10px rgba(52, 152, 219, 0.1); animation: fadeIn 0.5s ease;">
                <i class="fas fa-info-circle" style="font-size: 24px;"></i>
                <div>
                    <strong style="font-weight: 600; display: block; margin-bottom: 5px;">Dica:</strong>
                    Clique no nome de qualquer bloco para editar seu conteúdo e personalizá-lo para este cliente específico.
                </div>
            </div>
            
            <div class="ofertas-tabs">
                {% for oferta_nome, oferta_dados in ofertas.items() %}
                <div class="oferta-tab {% if rascunho.oferta_selecionada == oferta_nome %}active{% elif loop.first and not rascunho.oferta_selecionada %}active{% endif %}" 
                     data-oferta="{{ oferta_nome }}" onclick="selecionarOferta('{{ oferta_nome }}')">
                    {{ oferta_nome }}
                </div>
                {% endfor %}
            </div>
            
            <input type="hidden" name="oferta_selecionada" id="oferta_selecionada" value="{{ rascunho.oferta_selecionada or primeira_oferta }}">
            
            {% for oferta_nome, oferta_dados in ofertas.items() %}
            <div class="oferta-content {% if rascunho.oferta_selecionada == oferta_nome %}active{% elif loop.first and not rascunho.oferta_selecionada %}active{% endif %}" 
                 id="oferta-{{ oferta_nome }}">
                <div class="oferta-header">
                    <h3 class="oferta-title">{{ oferta_nome }}</h3>
                    <p class="oferta-description">Selecione os blocos para esta oferta</p>
                </div>
                
                <!-- Blocos Obrigatórios -->
                <div class="blocos-category">
                    <h4 class="blocos-category-title">Blocos Obrigatórios</h4>
                    <div class="checkbox-container">
                        {% for bloco_nome in oferta_dados.obrigatorios %}
                        <div class="checkbox-item">
                            <input type="checkbox" id="bloco-{{ bloco_nome }}" name="blocos" value="{{ bloco_nome }}" 
                                   {% if bloco_nome in rascunho.blocos_selecionados %}checked{% endif %} checked disabled>
                            <label for="bloco-{{ bloco_nome }}">
                                {{ bloco_nome.replace('_', ' ').capitalize() }}
                                <span class="mandatory-badge">Obrigatório</span>
                                <button type="button" class="btn-editar-bloco" data-bloco="{{ bloco_nome }}">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Blocos Específicos -->
                <div class="blocos-category">
                    <h4 class="blocos-category-title">Blocos Específicos</h4>
                    <div class="checkbox-container">
                        {% for bloco_nome, bloco_dados in oferta_dados.blocos.items() %}
                        <div class="checkbox-item">
                            <input type="checkbox" id="bloco-{{ bloco_nome }}" name="blocos" value="{{ bloco_nome }}"
                                   {% if bloco_nome in rascunho.blocos_selecionados %}checked{% endif %}>
                            <label for="bloco-{{ bloco_nome }}">
                                {{ bloco_nome.replace('_', ' ').capitalize() }}
                                <button type="button" class="btn-editar-bloco" data-bloco="{{ bloco_nome }}">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Blocos Adicionais -->
        <div class="card mb-4">
            <div class="card-header bg-dark" style="background: linear-gradient(135deg, #2c3e50, #1a1a2e) !important; padding: 20px; border-radius: 8px 8px 0 0;">
                <h5 class="mb-0 text-white" style="font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-layer-group"></i> Blocos Selecionados
                </h5>
            </div>
            <div class="card-body bg-light">
                <div class="row mb-4">
                    <div class="col-12">
                        <button type="button" id="btnNovoBloco" class="btn btn-success btn-lg" onclick="novoBloco()" style="background: linear-gradient(135deg, #2ecc71, #27ae60); border: none; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2); display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; width: 100%;">
                            <i class="fas fa-plus" style="font-size: 18px;"></i> 
                            <span style="font-size: 18px; font-weight: 600;">Adicionar Novo Bloco</span>
                        </button>
                    </div>
                </div>
                <div class="row">
                    {% for bloco in blocos_selecionados %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="card-title mb-0">{{ bloco.replace('_', ' ').title() }}</h6>
                            </div>
                            <div class="card-body">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-info" onclick="editarBloco('{{ bloco }}')" style="display: flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(135deg, #3498db, #2980b9); border: none; border-radius: 6px; padding: 10px 15px; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="excluirBloco('{{ bloco }}')" style="display: flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(135deg, #e74c3c, #c0392b); border: none; border-radius: 6px; padding: 10px 15px; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2);">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="submit-container">
            <div>
                <!-- Botão de salvar como rascunho removido, pois o auto-save já está implementado -->
            </div>
            <div>
                <button type="submit" class="btn-primary" style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 15px 30px; font-size: 18px; font-weight: 600; border-radius: 8px; box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3); display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;">
                    <i class="fas fa-file-pdf" style="font-size: 20px;"></i> Gerar Proposta
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Edição de Bloco -->
<div id="modalEditarBloco" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 12px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); border: none; padding: 30px; animation: modalFadeIn 0.3s ease;">
        <div class="modal-header" style="border-bottom: 2px solid #f0f2f5; margin-bottom: 25px; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h2 class="modal-title" style="font-size: 24px; font-weight: 600; color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-edit" style="color: #3498db;"></i> Editar Bloco: <span id="modalBlocoTitulo"></span>
            </h2>
            <span class="close" style="color: #7f8c8d; font-size: 30px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Editor Quill -->
            <div id="editor-bloco" style="height: 350px; border-radius: 8px; border: 1px solid #e0e6ed; margin-bottom: 20px;"></div>
            <input type="hidden" id="blocoAtual" value="">
            <input type="hidden" id="blocoConteudo" value="">
        </div>
        <div class="modal-footer" style="border-top: 2px solid #f0f2f5; margin-top: 25px; padding-top: 20px; display: flex; justify-content: flex-end; gap: 15px;">
            <button type="button" class="btn-secondary" id="btnCancelarEdicao" style="background: linear-gradient(135deg, #7f8c8d, #95a5a6); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" class="btn-primary" id="btnSalvarEdicao" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-save"></i> Salvar Alterações
            </button>
        </div>
    </div>
</div>

<!-- Modal de Novo Bloco -->
<div id="modalNovoBloco" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 12px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); border: none; padding: 30px; animation: modalFadeIn 0.3s ease;">
        <div class="modal-header" style="border-bottom: 2px solid #f0f2f5; margin-bottom: 25px; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h2 class="modal-title" style="font-size: 24px; font-weight: 600; color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-plus-circle" style="color: #2ecc71;"></i> Criar Novo Bloco
            </h2>
            <span class="close" style="color: #7f8c8d; font-size: 30px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group mb-3">
                <label for="nomeNovoBloco" class="form-label" style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; display: block;">Nome do Bloco:</label>
                <input type="text" id="nomeNovoBloco" class="form-control" placeholder="Ex: Descrição do Serviço" style="width: 100%; padding: 14px 18px; border: 1px solid #e0e6ed; border-radius: 8px; font-size: 16px; background-color: #f9fafc;">
            </div>
            <!-- Editor Quill para o conteúdo -->
            <div class="form-group">
                <label for="editor-novo-bloco" class="form-label" style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; display: block;">Conteúdo do Bloco:</label>
                <div id="editor-novo-bloco" style="height: 350px; border-radius: 8px; border: 1px solid #e0e6ed;"></div>
            </div>
        </div>
        <div class="modal-footer" style="border-top: 2px solid #f0f2f5; margin-top: 25px; padding-top: 20px; display: flex; justify-content: flex-end; gap: 15px;">
            <button type="button" class="btn-secondary" id="btnCancelarNovo" style="background: linear-gradient(135deg, #7f8c8d, #95a5a6); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" class="btn-primary" id="btnSalvarNovo" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-plus"></i> Criar Bloco
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

<script>
    function updateFileName(input) {
        const fileName = input.files[0] ? input.files[0].name : 'Nenhum arquivo selecionado';
        document.getElementById('file-name').textContent = fileName;
    }

    function previewLogo(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Apenas exibir a imagem selecionada se necessário
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar o editor Quill
        const quill = new Quill('#editor-bloco', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Edite o conteúdo do bloco aqui...'
        });
        
        // Inicializar o editor Quill para novos blocos
        const quillNovo = new Quill('#editor-novo-bloco', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Digite o conteúdo do novo bloco aqui...'
        });
        
        // Configurar o modal de edição
        const modal = document.getElementById('modalEditarBloco');
        const modalNovo = document.getElementById('modalNovoBloco');
        const span = modal.getElementsByClassName('close')[0];
        const spanNovo = modalNovo.getElementsByClassName('close')[0];
        const btnCancelar = document.getElementById('btnCancelarEdicao');
        const btnCancelarNovo = document.getElementById('btnCancelarNovo');
        const btnSalvar = document.getElementById('btnSalvarEdicao');
        const btnSalvarNovo = document.getElementById('btnSalvarNovo');
        
        span.onclick = function() {
            modal.style.display = 'none';
        }
        
        btnCancelar.onclick = function() {
            modal.style.display = 'none';
        }
        
        // Configurar botões de fechamento do modal novo bloco
        spanNovo.onclick = function() {
            modalNovo.style.display = 'none';
        }
        
        btnCancelarNovo.onclick = function() {
            modalNovo.style.display = 'none';
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            if (event.target == modalNovo) {
                modalNovo.style.display = 'none';
            }
        }
        
        // Configurar o botão de salvar edição
        btnSalvar.onclick = function() {
            const blocoNome = document.getElementById('blocoAtual').value;
            const conteudo = quill.root.innerHTML;
            
            console.log('Salvando bloco:', blocoNome);
            
            // Desabilitar o botão durante o salvamento
            btnSalvar.disabled = true;
            btnSalvar.textContent = 'Salvando...';
            
            // Salvar o conteúdo editado
            fetch('/api/salvar_bloco', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: blocoNome,
                    texto: conteudo
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Resposta do servidor:', data);
                
                if (data.success) {
                    alert('Bloco salvo com sucesso!');
                    modal.style.display = 'none';
                } else {
                    alert('Erro ao salvar o bloco: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar o bloco: ' + error.message);
            })
            .finally(() => {
                // Reabilitar o botão após o salvamento
                btnSalvar.disabled = false;
                btnSalvar.textContent = 'Salvar Alterações';
            });
        };
        
        // Configurar o botão de salvar novo bloco
        btnSalvarNovo.onclick = function() {
            const blocoNome = document.getElementById('nomeNovoBloco').value.trim().replace(/\s+/g, '_');
            const conteudo = quillNovo.root.innerHTML;
            
            if (!blocoNome) {
                alert('Por favor, informe um nome para o bloco.');
                return;
            }
            
            console.log('Criando novo bloco:', blocoNome);
            
            // Desabilitar o botão durante o salvamento
            btnSalvarNovo.disabled = true;
            btnSalvarNovo.textContent = 'Salvando...';
            
            // Salvar o novo bloco
            fetch('/api/salvar_bloco', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: blocoNome,
                    texto: conteudo
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Resposta do servidor:', data);
                
                if (data.success) {
                    alert('Bloco criado com sucesso!');
                    modalNovo.style.display = 'none';
                    
                    // Recarregar a página para mostrar o novo bloco
                    location.reload();
                } else {
                    alert('Erro ao criar o bloco: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao criar o bloco: ' + error.message);
            })
            .finally(() => {
                // Reabilitar o botão após o salvamento
                btnSalvarNovo.disabled = false;
                btnSalvarNovo.textContent = 'Criar Bloco';
            });
        };
        
        // Configurar os botões de edição inicialmente
        configurarBotoesEdicao();
    });
    
    // Função para editar um bloco
    function editarBloco(blocoNome) {
        const modal = document.getElementById('modalEditarBloco');
        const modalTitulo = document.getElementById('modalBlocoTitulo');
        const blocoAtual = document.getElementById('blocoAtual');
        
        console.log('Editando bloco:', blocoNome);
        
        // Definir o título do modal e o bloco atual
        modalTitulo.textContent = blocoNome.replace(/_/g, ' ').capitalize();
        blocoAtual.value = blocoNome;
        
        // Exibir o modal antes de carregar o conteúdo
        modal.style.display = 'block';
        
        // Inicializar o editor com conteúdo vazio
        const quill = Quill.find(document.getElementById('editor-bloco'));
        quill.root.innerHTML = '<p>Carregando conteúdo...</p>';
        
        // Carregar o conteúdo do bloco
        fetch(`/api/bloco/${blocoNome}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Dados do bloco recebidos:', data);
                
                // Inicializar o editor com o conteúdo do bloco
                quill.root.innerHTML = data.texto || '';
            })
            .catch(error => {
                console.error('Erro ao carregar o bloco:', error);
                quill.root.innerHTML = '<p>Erro ao carregar o conteúdo do bloco. Você pode editar mesmo assim e o bloco será criado.</p>';
            });
    }
    
    // Função para configurar os botões de edição
    function configurarBotoesEdicao() {
        document.querySelectorAll('.btn-editar-bloco').forEach(btn => {
            btn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const blocoNome = this.getAttribute('data-bloco');
                editarBloco(blocoNome);
            };
        });
    }
    
    // Função para selecionar uma oferta
    function selecionarOferta(ofertaNome) {
        // Atualizar o campo hidden com a oferta selecionada
        document.getElementById('oferta_selecionada').value = ofertaNome;
        
        // Atualizar as abas
        document.querySelectorAll('.oferta-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.oferta-tab[data-oferta="${ofertaNome}"]`).classList.add('active');
        
        // Atualizar o conteúdo
        document.querySelectorAll('.oferta-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`oferta-${ofertaNome}`).classList.add('active');
    }
    
    // Adicionar método capitalize ao protótipo de String
    String.prototype.capitalize = function() {
        return this.charAt(0).toUpperCase() + this.slice(1);
    };

    // Adicionar esta função no script do template criar_proposta.html
    function excluirBloco(blocoNome) {
        if (confirm(`Tem certeza que deseja excluir o bloco "${blocoNome}"?`)) {
            fetch(`/api/excluir_bloco/${blocoNome}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Bloco excluído com sucesso!');
                    location.reload(); // Recarrega a página para atualizar a lista
                } else {
                    alert('Erro ao excluir o bloco: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir o bloco: ' + error.message);
            });
        }
    }

    // Função para criar um novo bloco
    function novoBloco() {
        const modal = document.getElementById('modalNovoBloco');
        const quillNovo = Quill.find(document.getElementById('editor-novo-bloco'));
        
        // Limpar campos do formulário
        document.getElementById('nomeNovoBloco').value = '';
        quillNovo.root.innerHTML = '';
        
        // Exibir o modal
        modal.style.display = 'block';
    }
</script>
{% endblock %} 
